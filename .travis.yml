language: shell

os:
  - linux
  - windows

before_install:
- |-
  case $TRAVIS_OS_NAME in
    windows)
      [[ ! -f C:/tools/msys64/msys2_shell.cmd ]] && rm -rf C:/tools/msys64
      choco uninstall -y mingw
      choco upgrade --no-progress -y msys2
      export msys2='cmd //C RefreshEnv.cmd '
      export msys2+='& set MSYS=winsymlinks:nativestrict '
      export msys2+='& C:\\tools\\msys64\\msys2_shell.cmd -defterm -no-start'
      export mingw64="$msys2 -mingw64 -full-path -here -c "\"\$@"\" --"
      export msys2+=" -msys2 -c "\"\$@"\" --"
      $msys2 pacman --sync --noconfirm --needed base-devel
      $msys2 pacman --sync --noconfirm --needed mingw-w64-x86_64-toolchain
      $msys2 pacman --sync --noconfirm --needed mingw-w64-x86_64-gcc
      $msys2 pacman --sync --noconfirm --needed mingw-w64-x86_64-cmake
      taskkill //IM gpg-agent.exe //F  # https://travis-ci.community/t/4967
      export PATH=/C/tools/msys64/mingw64/bin:$PATH
      export MAKE=mingw32-make  # so that Autotools can find it
      ;;
  esac

before_cache:
- |-
  case $TRAVIS_OS_NAME in
    windows)
      # https://unix.stackexchange.com/a/137322/107554
      $msys2 pacman --sync --clean --noconfirm
      ;;
  esac

cache:
  directories:
    - $HOME/AppData/Local/Temp/chocolatey
    - /C/tools/msys64



addons:
  apt:
    sources:
      - ubuntu-toolchain-r-test
    packages:
      - gfortran-7

before_script:
  - export DISTROOT=. BUILDROOT=../build CMAKE=cmake
  - if [[ "$TRAVIS_OS_NAME" == "linux" ]]; then export FC=gfortran-7; ./scripts/build-json-fortran.sh; cmake -H$DISTROOT -B$BUILDROOT ; fi
  - if [[ "$TRAVIS_OS_NAME" == "windows" ]]; then $mingw64 ./scripts/build-json-fortran.sh; cmake -H$DISTROOT -B$BUILDROOT -G "MinGW Makefiles"; cp $BUILDROOT/json/libjsonfortran.dll $BUILDROOT/bin; fi
  - cmake --build $BUILDROOT

script:
  - cd $BUILDROOT
  - ./bin/config
  - ctest

before_deploy:
  - mv $BUILDROOT "simsphere-$TRAVIS_TAG"
  - if [[ "$TRAVIS_OS_NAME" == "linux" ]]; then tar cJvf simsphere-$TRAVIS_TAG.tar.xz simsphere-$TRAVIS_TAG; fi
  - if [[ "$TRAVIS_OS_NAME" == "windows" ]]; then zip simsphere-$TRAVIS_TAG; fi

deploy:
  - provider: releases
    skip_cleanup: true
    on:
      branch: v0.1.1
    file:
      - simsphere-$TRAVIS_TAG*
    api_key:
      secure: "TkkEUBPlR+9QvH4oMqJcLZMM3Z6tp5Ujyv0Tp0uwg11iUPuL5TMG5RRFUEJTyKHee7GMtyCmQr87JdgswcbxtF4dSlhoPlPSeBXBm4j8H16j8Bvc7W6jIlk8q3J35JLtAQg10LuLSiODaSDk5DobGIwfjtM+xvB6b7eT1iNBDWzgsc8CTHW2/nB+5URNt9rAcUDwQMrrEOxu5Jnr1lTc7HpEfsYgOUS6iV2Bhi/NuihTIlOE6gR/4emXj7CGHs2cyP+5hnqVC/16i3i0WtMDkZrY9FCP6VVXR4i6+n66zpB/gpm+7uAWdLMsXOb541ujofzUuNNqISwPg3DdXQSNxDRGUtQjxLBh6TU7ZB8ofuZFyPYHdKleEDvV+rU5xYZB3/oI+DZShbz566rgTlLEF+3FgkAxpKtkjtedxZplsDBi4RsT2NdiOvZKT3zhTPHzOutA6iwdj83xPYkA8tz50Nm4eIB+M2ipSsCRTQseMuYIk6yGo+oCy/WyK4LvRYQZkRXxFs1eT6hneMZxxDsl7w9VKErta46+wv7g4UWMuKjqYRV1RMOU/OtQZSKcX1bFaKh/IaLhA5cyW73FwxKV2QtaD0l2YXmRlRAknnhL659St6MFpUXRYuObOqO1NcBW2tr84oRYOcoYS1DX3Hd2OnDIvSV70PitGt3MWVYrWYo="

notifications:
  email: false


after_success:
 - bash <(curl -s https://codecov.io/bash)
